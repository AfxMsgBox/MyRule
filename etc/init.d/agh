#!/bin/sh /etc/rc.common

PROG=/usr/bin/AdGuardHome
WORK_DIR=/etc/proxy/agh

USE_PROCD=1

START=99

boot() {
  adguardhome_boot=1
  start "$@"
}

start_service() {
  if [ -n "$adguardhome_boot" ]; then
    # Do not start yet, wait for triggers
    return 0
  fi
  
  procd_open_instance
  procd_set_param command "$PROG" -c $WORK_DIR"/agh.yaml" -w "$WORK_DIR" --no-check-update
  procd_set_param stdout 1
  procd_set_param stderr 1
  procd_close_instance
}

service_triggers() {
  if [ -n "$adguardhome_boot" ]; then
    # Wait for interfaces to be up before starting AdGuard Home for real.
    # Prevents issues like https://github.com/openwrt/packages/issues/21868.
    procd_add_raw_trigger "interface.*.up" 5000 /etc/init.d/agh restart
  fi
}
